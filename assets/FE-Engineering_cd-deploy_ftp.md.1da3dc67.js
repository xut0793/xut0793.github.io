import{_ as n,c as s,o as a,a as p}from"./app.f1e974b0.js";const f='{"title":"FTP \u4E0A\u4F20","description":"","frontmatter":{},"headers":[{"level":2,"title":"\u4F7F\u7528 gulp + gulp-sftp-up4","slug":"\u4F7F\u7528-gulp-gulp-sftp-up4"},{"level":2,"title":"\u4F7F\u7528 webpack + sftp-webpack-plugin","slug":"\u4F7F\u7528-webpack-sftp-webpack-plugin"}],"relativePath":"FE-Engineering/cd-deploy/ftp.md"}',t={},o=p(`<h1 id="ftp-\u4E0A\u4F20" tabindex="-1">FTP \u4E0A\u4F20 <a class="header-anchor" href="#ftp-\u4E0A\u4F20" aria-hidden="true">#</a></h1><ol><li>\u5DE5\u7A0B\u4EE3\u7801\u5728\u672C\u5730\u8FDB\u884C\u751F\u4EA7\u73AF\u5883\u6784\u5EFA\uFF1A\u6BD4\u5982 vue + webpack \u7684\u5DE5\u7A0B\u9879\u76EE\u8FDB\u884C <code>npm run build</code> \u540E\uFF0C\u4F1A\u5C06\u8981\u90E8\u7F72\u5230\u7EBF\u4E0A\u73AF\u5883\u7684\u6587\u4EF6\u653E\u5728 <code>dist</code> \u76EE\u5F55</li><li>\u4F7F\u7528 FTP \u5BA2\u6237\u7AEF\u5DE5\u5177\uFF0C\u5982 <code>FileZilla</code> \u8FDE\u63A5\u8FDC\u7A0B\u670D\u52A1\u5668\uFF0C\u76F4\u63A5\u5C06 <code>dist</code> \u76EE\u5F55\u6587\u4EF6\u4E0A\u4F20\u5373\u53EF\u3002</li><li>\u4E5F\u53EF\u4EE5\u5C06 FTP \u624B\u52A8\u4E0A\u4F20\u4EE3\u7801\u64CD\u4F5C\u96C6\u6210\u5230\u547D\u4EE4\u884C\u64CD\u4F5C\uFF0C\u6BD4\u5982\u4F7F\u7528 <code>gulp + gulp-sftp-up4</code> \u6216\u8005 <code>webpack + sftp-webpack-plugin</code></li></ol><h2 id="\u4F7F\u7528-gulp-gulp-sftp-up4" tabindex="-1">\u4F7F\u7528 <code>gulp + gulp-sftp-up4</code> <a class="header-anchor" href="#\u4F7F\u7528-gulp-gulp-sftp-up4" aria-hidden="true">#</a></h2><div class="language-"><pre><code># \u5B89\u88C5 gulp \u548C gulp-sftp-upu4
npm i -D gulp gulp-sftp-up4
</code></pre></div><div class="language-js"><pre><code><span class="token comment">// \u65B0\u5EFA gulpfile.js \u6587\u4EF6</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> src <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;gulp&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> sftp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;gulp-sftp-up4&#39;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token constant">ASSET_PATH</span> <span class="token operator">=</span> <span class="token string">&#39;/dist/&#39;</span>
<span class="token keyword">const</span> <span class="token constant">FTP_CONFIG</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">remotePath</span><span class="token operator">:</span> <span class="token string">&#39;/home/hsiar/hsiar-green/html/cicd/&#39;</span><span class="token punctuation">,</span> <span class="token comment">//\u90E8\u7F72\u5230\u670D\u52A1\u5668\u7684\u8DEF\u5F84</span>
  <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">&#39;xx.xx.xx.xxx&#39;</span><span class="token punctuation">,</span> <span class="token comment">// \u670D\u52A1\u5668 ip \u5730\u5740</span>
  <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token comment">//\u7AEF\u53E3</span>
  <span class="token literal-property property">user</span><span class="token operator">:</span> <span class="token string">&#39;root&#39;</span><span class="token punctuation">,</span> <span class="token comment">//\u5E10\u53F7</span>
  <span class="token literal-property property">pass</span><span class="token operator">:</span> <span class="token string">&#39;***********&#39;</span><span class="token punctuation">,</span> <span class="token comment">//\u5BC6\u7801</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;## SFTP \u6B63\u5728\u4E0A\u4F20\u6784\u5EFA\u4EE3\u7801\u5230\u865A\u62DF\u673A\u6D4B\u8BD5\u670D\u52A1\u5668\u4E0A......&#39;</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token constant">ASSET_PATH</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">**</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">sftp</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token constant">FTP_CONFIG</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> callback <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

exports<span class="token punctuation">.</span>default <span class="token operator">=</span> upload
</code></pre></div><div class="language-json"><pre><code><span class="token comment">// \u6DFB\u52A0 run-script \u547D\u4EE4</span>
<span class="token property">&quot;script&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">&quot;sftp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;gulp&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;build:sftp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vue-cli-service build &amp;&amp; gulp&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="\u4F7F\u7528-webpack-sftp-webpack-plugin" tabindex="-1">\u4F7F\u7528 <code>webpack + sftp-webpack-plugin</code> <a class="header-anchor" href="#\u4F7F\u7528-webpack-sftp-webpack-plugin" aria-hidden="true">#</a></h2><div class="language-js"><pre><code><span class="token comment">// webpack.prod.config.js</span>
 <span class="token keyword">const</span> SftpWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./src/utils/mysftpWebpackPlugin&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
   <span class="token comment">// \u5176\u5B83\u914D\u7F6E</span>
   <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
     <span class="token keyword">new</span> <span class="token class-name">SftpWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
       <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token string">&#39;your port&#39;</span><span class="token punctuation">,</span><span class="token comment">//\u670D\u52A1\u5668\u7AEF\u53E3</span>
       <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">&#39;your host&#39;</span><span class="token punctuation">,</span><span class="token comment">//\u670D\u52A1\u5668\u5730\u5740</span>
       <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">&#39;your username&#39;</span><span class="token punctuation">,</span><span class="token comment">//\u7528\u6237\u540D</span>
       <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">&#39;your password&#39;</span><span class="token punctuation">,</span><span class="token comment">//\u5BC6\u7801</span>
       <span class="token literal-property property">from</span><span class="token operator">:</span> <span class="token string">&#39;/dist/&#39;</span><span class="token punctuation">,</span><span class="token comment">//\u4F60\u7684\u672C\u5730\u8DEF\u5F84</span>
       <span class="token literal-property property">to</span><span class="token operator">:</span> <span class="token string">&#39;you want to destination&#39;</span><span class="token comment">//\u670D\u52A1\u5668\u4E0A\u7684\u8DEF\u5F84</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
 <span class="token punctuation">}</span>
</code></pre></div><p>\u4E3B\u8981\u6E90\u7406\u5C31\u662F\u521B\u5EFA webpack \u63D2\u4EF6\u7684\u7ED3\u6784\uFF0C\u5E76\u76D1\u542C webpack \u7F16\u8F91\u7684 done \u4E8B\u4EF6\uFF0C\u7136\u540E\u521B\u5EFAftp\u5BA2\u6237\u7AEF\u4E0A\u4F20\u4EE3\u7801\u3002</p><div class="language-js"><pre><code><span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;scp2&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> sftpClient <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;ssh2-sftp-client&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> chalk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;chalk&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> validate <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;schema-utils&#39;</span><span class="token punctuation">)</span> <span class="token comment">// \u8FD9\u4E2A\u5305\u968F webpack \u9ED8\u8BA4\u5B89\u88C5\u7684\uFF0C\u7528\u4E8E\u6821\u9A8C\u914D\u7F6E\u5BF9\u8C61\u662F\u5426\u6B63\u786E\uFF0C\u4E0D\u6B63\u786E\u62A5\u9519</span>

<span class="token keyword">const</span> sftp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">sftpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> pluginName <span class="token operator">=</span> <span class="token string">&#39;sftpWebpackPlugin&#39;</span>
<span class="token keyword">const</span> sftpOptionSchema <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./sftpOptionSchema.json&#39;</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">WebpackDeploySftp</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">validate</span><span class="token punctuation">(</span>sftpOptionSchema<span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;sftp config options&#39;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">baseDataPath</span><span class="token operator">:</span> <span class="token string">&#39;options&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">consoleErrorInfo</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">deploy failure: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>pluginName<span class="token punctuation">,</span> <span class="token parameter">compilation</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> port<span class="token punctuation">,</span> host<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> from<span class="token punctuation">,</span> to <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options
      sftp<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">{</span> host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> sftp<span class="token punctuation">.</span><span class="token function">rmdir</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> remote <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>username<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>password<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">@</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>to<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span>
        client<span class="token punctuation">.</span><span class="token function">scp</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> remote<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">consoleErrorInfo</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">green</span><span class="token punctuation">(</span><span class="token string">&#39;deploy success&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          sftp<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">consoleErrorInfo</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        sftp<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> WebpackDeploySftp
</code></pre></div><div class="language-json"><pre><code><span class="token comment">// sftpOptionSchema.json</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;\u8FDC\u7A0B\u670D\u52A1\u5668IP&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;number&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;port&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;\u8FDC\u7A0B\u670D\u52A1\u5668\u7AEF\u53E3\u53F7&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;number&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;\u767B\u5F55\u8FDC\u7A0B\u670D\u52A1\u5668\u7684\u8D26\u53F7&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;string&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;password&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;\u767B\u5F55\u8FDC\u7A0B\u670D\u52A1\u5668\u7684\u5BC6\u7801&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;string&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;\u9700\u8981\u4E0A\u4F20\u7684\u672C\u5730\u6587\u4EF6\u76EE\u5F55&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;string&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;to&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;\u4E0A\u4F20\u5230\u8FDC\u7A0B\u670D\u52A1\u5668\u7684\u76EE\u5F55&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;string&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;additionalProperties&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div>`,11),e=[o];function c(u,l,i,k,r,d){return a(),s("div",null,e)}var y=n(t,[["render",c]]);export{f as __pageData,y as default};
